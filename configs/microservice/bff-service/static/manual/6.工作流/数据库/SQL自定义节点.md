# SQL自定义节点

#### **1. 功能简介**
**“SQL 自定义节点”**允许您在工作流中直接编写 SQL 语句，对指定的数据库进行增、删、改、查等高级数据操作。

*   **适用场景**：当图形化的“新增/查询/更新/删除数据”节点无法满足复杂的业务逻辑（如多表关联、复杂聚合计算）时使用。
*   **核心能力**：支持标准 SQL92 语法，支持通过变量引用上游数据。
> **💡 小贴士**：如果您不熟悉 SQL 语句，建议优先使用图形化的基础数据节点；如果您需要执行复杂逻辑，可以使用本节点功能。
---
#### **2. ⚠️ 重要说明与调试机制**
配置此节点前，必须理解其独特的**数据隔离机制**，这是导致“调试成功但线上失败”的常见原因。
*   **开发调试（沙盒环境）**：
    *   在工作流调试阶段，**不会**连接您的**线上数据**（真实数据库）。
    *   系统会创建一个临时的**测试数据表**。
    *   您需要先手动插入或修改测试数据，才能进行查、删、改等操作的测试。
*   **线上运行（生产环境）**：
    *   工流发布后，才会真正连接到您配置的数据库，并操作真实的线上数据。
*   **限制**：每个 SQL 自定义节点中，**仅支持添加一条 SQL 语句**。
*   点击数据表可查看数据表**测试数据、线上数据**、编辑表结构。

![image-20260108154905664](assets/image-20260108154905664.png)

![image-20260108154950308](assets/image-20260108154950308.png)

---
#### **3. 如何添加节点**
1.  打开您的低代码工作流画布。
2.  点击节点连接线上的 **“+”** 按钮。
3.  在左侧弹出的节点列表中，找到 **“数据库”** 分类。
4.  选择 **“SQL 自定义”** 节点，即可添加至画布。

![image-20260108141351070](assets/image-20260108141351070.png)

---
#### **4. 节点配置**
配置过程分为定义变量、选择数据表和编写 SQL 三个步骤。
**步骤一：定义输入参数（变量）**
在“输入”区域，定义 SQL 语句中需要用到的动态参数。

*   **变量来源**：可以设置为固定值，也可以引用上游节点的输出。
*   **引用方式**：定义好变量后，在 SQL 语句中使用 `{{变量名}}` 的格式进行引用。



**步骤二：选择数据表**

* 在“数据表”区域，添加需要操作的数据表（每个节点仅支持操作一张表）。

* **查看测试数据**：单击数据表或“查看数据”，可以打开详情页查看当前的测试数据。您可以在此手动添加测试数据，以便调试。

  

**步骤三：编写 SQL 语句**
在“SQL”区域输入具体的操作指令。

*   **语法支持**：兼容 SQL92 常用语法。
*   **变量注入**：如需使用输入参数，请使用格式 `{{变量名}}`。
    *   *示例*：`SELECT * FROM users WHERE id = {{user_id}};`

---
#### **5. 输出与异常处理**
**输出参数**

| 参数名       | 类型    | 说明                                                         |
| :----------- | :------ | :----------------------------------------------------------- |
| `outputList` | Array   | SQL 执行后的查询结果列表。<br>**注意**：您可以在输出结构中新增子项，但**变量名必须与 SQL 查询结果的字段名完全一致**。 |
| `rowNum`     | Integer | 受影响的行数。<br>• 查询操作：固定为 0。<br>• 增/删/改操作：返回实际受影响的行数。 |
| `isSuccess`  | Boolean | 节点是否执行成功。<br>*(仅在异常处理设置为“返回设定内容”或“执行异常流程”时返回)* |
| `errorBody`  | Object  | 错误详情，包含 `errorMessage` 和 `errorCode`。<br>*(仅在异常发生且上述配置开启时返回)* |

**异常处理策略**：

当节点运行超时或出现异常时，您可以选择以下处理方式：

| 配置项           | 说明                                                         |      |
| :--------------- | :----------------------------------------------------------- | :--- |
| **超时时间**     | 默认为 60s。可调整范围为 0.1s ~ 60s。                        |      |
| **重试次数**     | 默认不重试。可设置为重试 1 次。                              |      |
| **异常处理方式** | <br>• **中断流程（默认）**：工作流停止运行，并在界面/API 返回错误信息。<br>• **返回设定内容**：工作流继续运行，返回自定义的 JSON 格式数据（含 `isSuccess` 和 `errorBody`）。<br>• **执行异常流程**：工作流转入异常分支继续执行，并将错误信息通过输出参数传递。 |      |

---
#### **6. 典型应用场景**
**场景：大模型动态生成 SQL 并执行**
您可以组合“大模型节点”和“SQL 自定义节点”，实现用自然语言操控数据库。
1.  **开始节点**：接收用户输入，如“查询user表中的name”。
2.  **大模型节点**：
    *   设定角色：专业的 SQL 生成助手。
    *   提示词：将自然语言转为 SQL，且**只返回 SQL 语句本身**，不要包含其他解释。
    *   输出：纯 SQL 文本（例如：`SELECT name FROM user;`）。
3.  **SQL 自定义节点**：
    *   引用大模型的输出作为 SQL 语句。
    *   执行该语句并返回结果。
4.  **结束节点**：将查询结果返回给用户。

![image-20260108154733773](assets/image-20260108154733773.png)

![image-20260108154817787](assets/image-20260108154817787.png)
